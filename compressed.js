!function(){function e(e,n,t){function r(e,n){for(var r=0;r<a.length;r++){var l=a[r];if(l.x===e&&l.y===n)return}var f=e+"-"+n;if(!i[f]){i[f]=!0;for(var r=0;r<t.length;r++){var u=t[r];if(u.x===e&&u.y===n)return o.push(u),void a.push(u)}}}var a=n.slice(0);a.push(e);for(var i={},o=[];a.length>0;){var l=a.shift(),f=l.feature;if(f&&f.isExplosive){var u=l.x,c=l.y;r(u-1,c-1),r(u-1,c),r(u-1,c+1),r(u,c-1),r(u,c),r(u,c+1),r(u+1,c-1),r(u+1,c),r(u+1,c+1)}}return o}function n(){var e=[{name:"blue",value:"#2547f4"},{name:"cyan",value:"#17cfcf"},{name:"green",value:"#36cf17"},{name:"violet",value:"#ab30e8"},{name:"red",value:"#e83030"}];return{getByName:function(n){return e.filter(function(e){return e.name===n})[0]},getRandom:function(){return e[Math.floor(Math.random()*e.length)]}}}function t(e,n){return{getByName:function(t){return"explosive"===t?u(e,n):"locked"===t?s(e,n):null},getRandom:function(){var t=Math.random();return.1>t?u(e,n):.12>t?s(e,n):null},resize:function(n){e=n}}}function r(e,n){function t(e,n){e.moveTo(-i,-i+a*n),e.lineTo(i,-i+a*n),e.moveTo(-i+a*n,-i),e.lineTo(-i+a*n,i)}function r(){a=e/n,i=e/2,o=Math.ceil(1.01*e),l=o/2,f.width=f.height=o;var r=f.getContext("2d");r.translate(l,l),r.beginPath();for(var u=1;n>u;u++)t(r,u);r.lineWidth=.003*e,r.strokeStyle="#333",r.stroke(),r.beginPath(),t(r,0),t(r,n),r.lineWidth=.005*e,r.strokeStyle="#666",r.stroke()}var a,i,o,l,f=document.createElement("canvas");return r(),{paint:function(e){e.drawImage(f,-l,-l)},resize:function(n){e=n,r()}}}function a(e,n,t,r,a,i){var o=Math.PI;e.beginPath(),e.arc(n,t,r,0,2*o),e.fillStyle=a,e.fill(),null!==i&&i.paint(e,n,t,r);var l=.64*r;e.beginPath(),e.moveTo(n,t-l),e.arc(n,t,l,.5*-o,.25*-o),e.strokeStyle="white",e.lineWidth=.2*r,e.stroke()}function i(e,n){return{x:e,y:n}}function o(e,n,t){function r(){a=n/t,i=a/2*.68,o=-n/2+a/2}for(var a,i,o,l=Date.now(),f=[],u=0;u<e.length;u++)for(var c=e[u],s=0;4>s;s++)f.push(b(c.x,c.y,c.color.value));return r(),{paint:function(e){var n=(Date.now()-l)/500;if(n>1)return!1;e.save(),e.translate(o,o);for(var t=0;t<f.length;t++)f[t].paint(e,n,a);return e.restore(),!0},resize:function(e){n=e,r()}}}function l(e,n,t){function r(e,n,t){a(e,n.x*o,n.y*o,t,n.color.value,n.feature)}function i(){o=n/t,l=o/2*.68,u=-n/2+o/2,f=.3*l}var o,l,f,u,c=Date.now();return i(),{balls:e,paint:function(n){var t=(Date.now()-c)/500;if(t>1)return!1;n.save(),n.translate(u,u);for(var a=l+t*f,i=0;i<e.length;i++)r(n,e[i],a);return n.restore(),!0},resize:function(e){n=e,i()}}}function f(e,n,t,r,i){function o(e,n,t){a(e,n.x*f,n.y*f,t,n.color.value,n.feature)}function l(){f=r/i,u=f/2*.68,s=-r/2+f/2,c=.3*u}var f,u,c,s,v=Date.now();return l(),{affectedBalls:n,balls:t,movingBall:e,paint:function(n){var r=(Date.now()-v)/500;if(r>1)return!1;n.save(),n.translate(s,s);for(var a=u+r*c,i=0;i<t.length;i++)o(n,t[i],a);return o(n,e,a),n.restore(),!0},resize:function(e){r=e,l()}}}function u(e,n){function t(){r=e/n,a=.27*r,i=.12*r,o=.07*r}var r,a,i,o,l=Math.PI/3;return t(),{name:"explosive",isExplosive:!0,paint:function(e,n,t,f){e.save(),e.translate(n,t);var u=f/(.32*r);e.beginPath(),e.lineCap="butt";for(var c=0;3>c;c++)e.moveTo(a,0),e.arc(0,0,a*u,0,l),e.lineTo(Math.cos(l)*i,Math.sin(l)*i),e.arc(0,0,i*u,l,0,!0),e.closePath(),e.rotate(2*l);e.arc(0,0,o*u,0,2*Math.PI),e.fillStyle="rgba(255, 255, 255, 0.5)",e.fill(),e.restore()},resize:function(n){e=n,t()}}}function c(e,n,t,r,a,i){for(var o={},l=[{x:e,y:n,fromX:null,fromY:null}],f=null,u=!1;l.length;){var c=l.shift(),s=c.x,v=c.y;if(!(0>s||0>v||s>i-1||v>i-1)){var h=s+"-"+v;if(!o[h]){o[h]={x:c.fromX,y:c.fromY};for(var x=!1,y=0;y<a.length;y++){var g=a[y];if(g.x===s&&g.y===v){x=!0;break}}if(!x){if(s===t&&v===r){u=!0;break}l.push({x:s+1,y:v,fromX:s,fromY:v}),l.push({x:s-1,y:v,fromX:s,fromY:v}),l.push({x:s,y:v+1,fromX:s,fromY:v}),l.push({x:s,y:v-1,fromX:s,fromY:v})}}}}if(u){for(var f=[],s=t,v=r;;){var c=o[s+"-"+v];if(null===c.x)break;f.push({x:s,y:v}),s=c.x,v=c.y}f.push({x:e,y:n}),f=f.reverse()}return f}function s(e,n){function t(){r=e/n,a=.38*r,i=.24*r,o=.02*-r,l=.12*r,f=o-.11*r,u=.05*r}var r,a,i,o,l,f,u;return t(),{name:"locked",isLocked:!0,paint:function(e,n,t,c){e.save(),e.translate(n,t);var s=c/(.32*r);e.beginPath(),e.lineCap="butt",e.moveTo(-l*s,o*s),e.lineTo(-l*s,f*s),e.arc(0,f*s,l*s,-Math.PI,0),e.lineTo(l*s,o*s),e.lineWidth=s*u,e.strokeStyle="rgba(255, 255, 255, 0.6)",e.stroke(),e.beginPath(),e.rect(-a*s*.5,o*s,a*s,i*s),e.fillStyle="rgba(255, 255, 255, 0.6)",e.fill(),e.restore()},resize:function(n){e=n,t()}}}function v(){function a(e,n){J.push(i(e,n))}function u(e,n,t,r){j.push(m(e,n,t,r,ln,D))}function s(e,n,t,r){U.push(P(e,n,t,r,ln,D))}function v(){s(K.x,K.y,K.color,K.feature),K=null}function h(){for(var e=0;D>e;e++)for(var n=0;D>n;n++)a(n,e)}function x(){R(J);for(var e=0;j.length;){var n=j.shift();s(n.x,n.y,n.color,n.feature),e++}for(;3>e;){var t=J.shift();if(!t)break;s(t.x,t.y,F.getRandom(),q.getRandom()),e++}J.length||(V=l(U.slice(0),ln,D),U.splice(0),h());for(var r=0;3>r;r++){var t=J.shift();if(!t)break;u(t.x,t.y,F.getRandom(),q.getRandom())}w()}function y(){if(null===G){var e=Date.now();G=L(function(){G=null,(innerWidth!==O||innerHeight!==W)&&S(),rn.fillStyle="rgba(0, 0, 0, 0.8)",rn.fillRect(0,0,E,C),rn.save(),rn.translate(I,X),b(),rn.restore(),N.paint(rn),H.paint(rn);var n=Date.now()-e;n>20?y():setTimeout(y,20-n)})}}function b(){rn.lineCap="round",A.paint(rn);for(var n=0;n<U.length;n++)U[n].paint(rn);for(var n=0;n<j.length;n++)j[n].paint(rn);if(null!==K&&K.paint(rn),null!==Q&&!Q.paint(rn)){var t=d(Q,U,D);if(null===t){for(var n=0;n<j.length;n++){var r=j[n];if(r.x===Q.x&&r.y===Q.y){j.splice(n,1);break}}for(var n=0;n<J.length;n++){var i=J[n];if(i.x===Q.x&&i.y===Q.y){J.splice(n,1);break}}s(Q.x,Q.y,Q.color,Q.feature),N.add(1),x()}else{for(var n=0;n<t.length;n++){var l=t[n];U.splice(U.indexOf(l),1),a(l.x,l.y)}var u=e(Q,t,U);Z=f(Q,u,t,ln,D)}Q=null}if(null!==Z&&!Z.paint(rn)){var c=Z.balls;c.push(Z.movingBall);for(var u=Z.affectedBalls,n=0;n<u.length;n++){var v=u[n];U.splice(U.indexOf(v),1),a(v.x,v.y),c.push(v)}N.add(c.length),$=o(c,ln,D),Z=null,w()}null!==_&&_.paint(rn),null!==$&&($.paint(rn)||($=null)),null!==V&&(V.paint(rn)||($=o(V.balls,ln,D),x(),V=null,N.reset(),w()))}function S(){E=innerWidth*devicePixelRatio,C=innerHeight*devicePixelRatio,I=E/2,X=C/2,tn.width=Math.floor(E),tn.height=Math.floor(C),ln=.95*Math.min(E,C);var e=E/C;1>e&&(e=1/e),1.07>e&&(ln*=.95),1.12>e&&(ln*=.95),1.17>e&&(ln*=.95),1.22>e&&(ln*=.95),fn=ln/2,un=ln/D,N.resize(E,C,un),A.resize(ln),H.resize(E,ln),q.resize(ln);for(var n=0;n<U.length;n++)U[n].resize(ln);for(var n=0;n<j.length;n++)j[n].resize(ln);null!==K&&K.resize(ln),null!==Q&&Q.resize(ln),null!==V&&V.resize(ln),null!==Z&&Z.resize(ln),null!==$&&$.resize(ln),null!==_&&_.resize(ln),tn.style.top=-X+"px",tn.style.left=-I+"px",tn.style.transform="scale("+1/devicePixelRatio+")",O=innerWidth,W=innerHeight}function w(){localStorage.state=JSON.stringify({score:N.get(),steadyBalls:U.map(Y),nextBalls:j.map(Y)})}function T(e,n,t,r){K=z(e,n,t,r,ln,D),_=g(K,U,ln,D)}function R(e){for(var n=0;n<e.length;n++){var t=n+Math.floor(Math.random()*(e.length-n)),r=e[n];e[n]=e[t],e[t]=r}}function B(e){if(null===Q&&null===V&&null===Z)if(e.clientX*devicePixelRatio>E-un&&e.clientY*devicePixelRatio<un)for(null!==K&&(v(),_=null),V=l(U.slice(0),ln,D);U.length;){var n=U.pop();a(n.x,n.y)}else{var t=Math.floor((e.clientX*devicePixelRatio-I+fn)/un),r=Math.floor((e.clientY*devicePixelRatio-X+fn)/un);if(!(0>t||0>r||t>D-1||r>D-1))if(null===K)for(var i=0;i<U.length;i++){var o=U[i];if(o.x===t&&o.y===r){var f=o.feature;if(f&&f.isLocked)return;return U.splice(i,1),void T(t,r,o.color,o.feature)}}else{if(t===K.x&&r===K.y)return v(),void(_=null);for(var i=0;i<U.length;i++){var o=U[i];if(o.x===t&&o.y===r){var f=o.feature;if(f&&f.isLocked)return;return v(),U.splice(i,1),void T(t,r,o.color,o.feature)}}var u=c(K.x,K.y,t,r,U,D);u&&(a(K.x,K.y),Q=p(K.x,K.y,t,r,K.color,K.feature,u,ln,D),K=null,_=null)}}}function Y(e){var n={x:e.x,y:e.y,color:e.color.name};return e.feature&&(n.feature=e.feature.name),n}var E,C,I,X,N=k(),D=8,O=null,W=null,H=M(E,ln,D),A=r(ln,D),L=window.requestAnimationFrame;L||(L=window.mozRequestAnimationFrame),L||(L=function(e){return setTimeout(e,0)});var F=n(),q=t(ln,D),G=null,J=[],U=[],j=[],K=null,Q=null,V=null,Z=null,$=null,_=null;window.steadyBalls=U,window.nextBalls=j,window.emptySlots=J;var en="MainPanel",nn=!1,tn=document.createElement("canvas");tn.className=en+"-canvas",tn.addEventListener("mousedown",function(e){return 0===e.button?nn?void(nn=!1):void B(e):void 0}),tn.addEventListener("touchstart",function(e){nn=!0,B(e.changedTouches[0])});var rn=tn.getContext("2d"),an=document.createElement("div");an.className=en+"-center",an.appendChild(tn);var on=document.createElement("div");on.className=en,on.appendChild(an);var ln,fn,un;return{element:on,init:function(){var e=localStorage.state;if(e){var n=JSON.parse(e);N.set(n.score),n.steadyBalls.forEach(function(e){var n=q.getByName(e.feature),t=F.getByName(e.color);s(e.x,e.y,t,n)}),n.nextBalls.forEach(function(e){var n=q.getByName(e.feature),t=F.getByName(e.color);u(e.x,e.y,t,n)});for(var t=0;D>t;t++)for(var r=0;D>r;r++){for(var i=!0,o=0;o<U.length;o++){var l=U[o];if(l.x===r&&l.y===t){i=!1;break}}if(i){for(var o=0;o<j.length;o++){var f=j[o];if(f.x===r&&f.y===t){i=!1;break}}i&&a(r,t)}}}else h(),x();y()}}}function h(e,n,t,r){return{fromX:e,fromY:n,toX:t,toY:r}}function x(e,n,t,r){function a(e,n,t,r){l.push(h(e,n,t,r))}function i(e,t){for(var r=0;r<n.length;r++){var a=n[r];if(a.x===e&&a.y===t)return!0}return!1}function o(){v=-t/2,x=t/r}for(var l=[],f=0;f<n.length;f++){var u=n[f],c=u.x,s=u.y;i(c,s-1)||a(c,s,c+1,s),i(c,s+1)||a(c,s+1,c+1,s+1),i(c-1,s)||a(c,s,c,s+1),i(c+1,s)||a(c+1,s,c+1,s+1)}var v,x;return o(),{paint:function(n){n.save(),n.translate(v,v),n.beginPath();for(var r=0;r<l.length;r++){var a=l[r];n.moveTo(a.fromX*x,a.fromY*x),n.lineTo(a.toX*x,a.toY*x)}n.lineWidth=.005*t,n.lineCap="round",n.strokeStyle=e.color.value,n.stroke(),n.restore()},resize:function(e){t=e,o()}}}function y(e,n){return{x:e,y:n}}function g(e,n,t,r){function a(){p=-t/2,m=t/r,b=Math.ceil(1.01*t),M=b/2,i.width=i.height=b;var n=i.getContext("2d");n.translate(M,M),n.save(),n.translate(p,p),n.globalAlpha=.2,n.beginPath();for(var a=0;a<f.length;a++){var o=f[a];n.rect(o.x*m,o.y*m,m,m)}n.fillStyle=e.color.value,n.fill(),n.restore(),k.paint(n)}for(var i=document.createElement("canvas"),o={},l=[{x:e.x,y:e.y}],f=[];l.length;){var u=l.shift(),c=u.x,s=u.y;if(!(0>c||0>s||c>r-1||s>r-1)){var v=c+"-"+s;if(!o[v]){o[v]=!0;for(var h=!1,g=0;g<n.length;g++){var d=n[g];if(d.x===c&&d.y===s){h=!0;break}}h||(f.push(y(c,s)),l.push({x:c+1,y:s}),l.push({x:c-1,y:s}),l.push({x:c,y:s+1}),l.push({x:c,y:s-1}))}}}var p,m,b,M,k=x(e,f,t,r);return a(),{paint:function(e){e.drawImage(i,-M,-M)},resize:function(e){t=e,k.resize(t),a()}}}function d(e,n,t){function r(r,i,o,l){function f(r,a){for(var i=e.x,o=e.y;;){if(i+=r,o+=a,0>i||0>o||i>t-1||o>t-1)break;for(var l=!1,f=0;f<n.length;f++){var c=n[f];if(c.x===i&&c.y===o){c.color===e.color&&(u.push(c),l=!0);break}}if(!l)break}}var u=[];f(r,i),f(o,l),u.length>3&&a.push.apply(a,u)}var a=[];return r(-1,0,1,0),r(0,-1,0,1),r(-1,-1,1,1),r(-1,1,1,-1),a.length?a:null}function p(e,n,t,r,i,o,l,f,u){function c(){v=f/u,s=-f/2+f/(2*u),h=.14*v}var s,v,h,x=l.shift(),y=0;return c(),{color:i,feature:o,x:t,y:r,paint:function(t){return y++,2!==y||(y=0,x=l.shift())?(e=x.x,n=x.y,visualX=s+e*v,visualY=s+n*v,a(t,visualX,visualY,h,i.value,null),!0):!1},resize:function(e){f=e,c()}}}function m(e,n,t,r,i,o){function l(){var t=i/o;f=.14*t;var r=-i/2+i/(2*o);u=r+e*t,c=r+n*t}var f,u,c;return l(),{color:t,feature:r,x:e,y:n,paint:function(e){a(e,u,c,f,t.value,null)},resize:function(e){i=e,l()}}}function b(e,n,t){var r=Math.PI,a=.008,i=Math.random()*r*2;e+=Math.cos(i)*a,n+=Math.sin(i)*a;var a=.5,i=Math.random()*r*2,o=Math.cos(i)*a,l=Math.sin(i)*a,f=.04*-Math.random();return{paint:function(a,i,u){a.beginPath(),a.arc(e*u+u*o*i,n*u+u*l*i,.2*u*(1-i),0,2*r),a.fillStyle=t,a.fill(),n+=f}}}function M(e,n,t){function r(){a=n/t,i=.12*a,o=.4*a,l=e-3.2*i-.25*a,f=.25*a}var a,i,o,l,f;return r(),{paint:function(n){n.save(),n.strokeStyle="#808080",n.beginPath(),n.translate(e-.5*a,.5*a),n.arc(0,0,.2*a,-Math.PI,.25*Math.PI),n.moveTo(.26*-a,.2*-a),n.lineTo(.26*-a,0),n.lineTo(.06*-a,0),n.lineWidth=.08*a,n.stroke(),n.restore()},resize:function(t,a){e=t,n=a,r()}}}function k(){function e(e){i>0&&i--,i>0&&(e.fillStyle=l)}function n(e){a>0&&a--,a>0&&(e.fillStyle=l)}var t,r=0,a=0,i=0,o=50,l="#f7f76e",f=parseInt(localStorage.highScore,10);isFinite(f)||(f=0);var u,c,s;return{add:function(e){r+=e,a=o,r>f&&(f=r,i=o,localStorage.highScore=f)},get:function(){return r},paint:function(a){a.save();var i=.26*s,o=.5*s,l=.1*s,v="normal "+i+"px sans-serif",h="normal "+.5*s+"px sans-serif";a.fillStyle="#808080",a.textBaseline="top",u>c?(a.save(),n(a),a.translate(t,t),a.textAlign="right",a.rotate(.5*-Math.PI),a.font=v,a.fillText("YOUR SCORE",0,0),a.font=h,a.fillText(r,0,i+l),a.restore(),a.save(),a.translate(t,c-t),a.textAlign="left",a.rotate(.5*-Math.PI),a.font=v,e(a),a.fillText("HIGH SCORE",0,0),a.font=h,a.fillText(f,0,i+l),a.restore()):(a.save(),n(a),a.font=v,a.fillText("YOUR SCORE",t,t),a.font=h,a.fillText(r,t,t+i+l),a.restore(),a.save(),e(a),a.font=v,a.fillText("HIGH SCORE",t,c-t-o-l-i),a.font=h,a.fillText(f,t,c-t-o),a.restore()),a.restore()},reset:function(){r=0},resize:function(e,n,r){u=e,c=n,s=r,t=.25*s},set:function(e){r=e}}}function z(e,n,t,r,i,o){function l(){var t=i/o;f=.34*t;var r=-i/2+i/(2*o);u=r+e*t,c=r+n*t}var f,u,c,s=Date.now();return l(),{color:t,feature:r,x:e,y:n,paint:function(e){var n=Math.sin(.008*(Date.now()-s)),i=n;if(0>n&&(i*=.3),e.save(),e.translate(u,c-i*f*.4),0>n){var o=.15*n;e.scale(1-o,1+o)}a(e,0,0,f,t.value,r),e.restore()},resize:function(e){i=e,l()}}}function P(e,n,t,r,i,o){function l(){var t=i/o;f=.34*t;var r=-i/2+i/(2*o);u=r+e*t,c=r+n*t}var f,u,c;return l(),{color:t,feature:r,x:e,y:n,paint:function(e){a(e,u,c,f,t.value,r)},resize:function(e){i=e,l(),null!==r&&r.resize(i)}}}!function(){var e=v();document.body.appendChild(e.element),e.init()}()}();